stages:
  - test
  - build
  - docker
  - deploy

############################
# Variables globales
############################
variables:
  MAVEN_CLI_OPTS: "-B -Dmaven.repo.local=.m2/repository"
  DOCKER_BUILDKIT: "1"

############################
# Configuration par dÃ©faut
# (Maven sur runner Kubernetes)
############################
default:
  image: maven:3.9-eclipse-temurin-21
  tags:
    - kubernetes
  cache:
    key: "m2-${CI_PROJECT_ID}-${CI_COMMIT_REF_SLUG}"
    paths:
      - .m2/repository
    policy: pull-push

############################
# Tests unitaires
############################
verify:
  stage: test
  script:
    - chmod +x ./mvnw
    - ./mvnw $MAVEN_CLI_OPTS -DskipTests=false -DskipITs=true verify
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - target/surefire-reports/**
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

############################
# Tests dâ€™intÃ©gration
############################
integration-tests:
  stage: test
  services:
    - name: postgres:16-alpine
      alias: pg
  variables:
    POSTGRES_DB: service_article
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://pg:5432/service_article
    QUARKUS_DATASOURCE_USERNAME: postgres
    QUARKUS_DATASOURCE_PASSWORD: postgres
  script:
    - chmod +x ./mvnw
    - ./mvnw $MAVEN_CLI_OPTS -DskipTests=true -DskipITs=false verify
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - target/failsafe-reports/**
  needs: ["verify"]
  rules:
    - if: $CI_COMMIT_BRANCH

############################
# Build applicatif
############################
package:
  stage: build
  needs: ["verify"]
  script:
    - chmod +x ./mvnw
    - ./mvnw $MAVEN_CLI_OPTS -DskipTests package
  artifacts:
    expire_in: 1 week
    paths:
      - target/quarkus-app/**
      - target/*-runner.jar
  rules:
    - if: $CI_COMMIT_BRANCH

############################
# Build & push image Docker
# (runner Docker dÃ©diÃ©)
############################
build_image:
  stage: docker
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug  # â† Ajouter -debug !
    entrypoint: [""]
  tags:
    - kubernetes
  variables:
    FF_USE_LEGACY_KUBERNETES_EXECUTION_STRATEGY: "false"
    FF_KUBERNETES_HONOR_ENTRYPOINT: "true"
    DOCKER_CONFIG: /kaniko/.docker
    
  script:
    - echo "ðŸ”§ Configuration Kaniko..."
    - mkdir -p /kaniko/.docker
    - |
      cat > /kaniko/.docker/config.json <<EOF
      {
        "auths": {
          "${CI_REGISTRY}": {
            "auth": "$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')"
          }
        }
      }
      EOF
    
    - echo "âœ… Authentification configurÃ©e"
    
    - echo "ðŸ”¨ Lancement du build..."
    - |
      /kaniko/executor \
        --context "${CI_PROJECT_DIR}" \
        --dockerfile "${CI_PROJECT_DIR}/Dockerfile" \
        --destination "${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}" \
        --destination "${CI_REGISTRY_IMAGE}:latest" \
        --cache=true \
        --verbosity=info
    
    - echo "âœ… Build terminÃ©"
  
  needs: ["package"]
  rules:
    - if: $CI_COMMIT_BRANCH



############################
# DÃ©ploiement production
############################
deploy:production:
  stage: deploy
  image:
    name: bitnami/kubectl:latest
    entrypoint: [""]
  tags:
    - kubernetes
  needs:
    - job: build_image
      artifacts: false
  script:
    - kubectl version --client
    - kubectl create namespace production --dry-run=client -o yaml | kubectl apply -f -
    - |
      kubectl create secret docker-registry gitlab-registry \
        --docker-server="$CI_REGISTRY" \
        --docker-username="$CI_REGISTRY_USER" \
        --docker-password="$CI_REGISTRY_PASSWORD" \
        --namespace=production \
        --dry-run=client -o yaml | kubectl apply -f -
    - |
      kubectl create secret generic article-service-secrets \
        --from-literal=db.username="$QUARKUS_DATASOURCE_USERNAME" \
        --from-literal=db.password="$QUARKUS_DATASOURCE_PASSWORD" \
        --namespace=production \
        --dry-run=client -o yaml | kubectl apply -f -
    - |
      kubectl create configmap article-service-config \
        --from-literal=datasource.jdbc.url="$QUARKUS_DATASOURCE_JDBC_URL" \
        --namespace=production \
        --dry-run=client -o yaml | kubectl apply -f -
    - kubectl apply -f k8s/ -n production
    - kubectl set image deployment/article-service \
      article-service="$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA" \
      -n production
    - kubectl rollout status deployment/article-service -n production --timeout=5m
  environment:
    name: production
    url: https://satisfactorysquad.freeboxos.fr/article-service
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  allow_failure: false

############################
# DÃ©ploiement branches
############################
deploy:branch:
  stage: deploy
  image:
    name: bitnami/kubectl:latest
    entrypoint: [""]
  tags:
    - kubernetes
  needs:
    - job: build_image
      artifacts: false
  script:
    - kubectl create namespace "$CI_COMMIT_REF_SLUG" --dry-run=client -o yaml | kubectl apply -f -
    - |
      kubectl create secret docker-registry gitlab-registry \
        --docker-server="$CI_REGISTRY" \
        --docker-username="$CI_REGISTRY_USER" \
        --docker-password="$CI_REGISTRY_PASSWORD" \
        --namespace="$CI_COMMIT_REF_SLUG" \
        --dry-run=client -o yaml | kubectl apply -f -
    - |
      kubectl create secret generic article-service-secrets \
        --from-literal=db.username="$QUARKUS_DATASOURCE_USERNAME" \
        --from-literal=db.password="$QUARKUS_DATASOURCE_PASSWORD" \
        --namespace="$CI_COMMIT_REF_SLUG" \
        --dry-run=client -o yaml | kubectl apply -f -
    - |
      kubectl create configmap article-service-config \
        --from-literal=datasource.jdbc.url="$QUARKUS_DATASOURCE_JDBC_URL" \
        --namespace="$CI_COMMIT_REF_SLUG" \
        --dry-run=client -o yaml | kubectl apply -f -
    - kubectl apply -f k8s/ -n "$CI_COMMIT_REF_SLUG"
    - kubectl set image deployment/article-service \
      article-service="$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA" \
      -n "$CI_COMMIT_REF_SLUG"
    - kubectl rollout status deployment/article-service -n "$CI_COMMIT_REF_SLUG" --timeout=5m
  environment:
    name: "$CI_COMMIT_REF_SLUG"
    url: https://satisfactorysquad.freeboxos.fr/$CI_COMMIT_REF_SLUG/article-service
  rules:
    - if: $CI_COMMIT_BRANCH != "main"
  allow_failure: false
