stages:
  - test
  - build
  - docker
  - deploy

# Variables globales
variables:
  MAVEN_CLI_OPTS: "-B -Dmaven.repo.local=.m2/repository"
  DOCKER_BUILDKIT: "1"

default:
  image: maven:3.9-eclipse-temurin-21
  tags: 
    - kubernetes
  cache:
    key: "m2-${CI_PROJECT_ID}-${CI_COMMIT_REF_SLUG}"
    paths:
      - .m2/repository
    policy: pull-push

verify:
  stage: test
  tags: 
    - kubernetes
  script:
    - ./mvnw $MAVEN_CLI_OPTS -DskipTests=false -DskipITs=true verify
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - target/surefire-reports/**
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

package:
  stage: build
  tags: 
    - kubernetes
  needs: ["verify"]
  script:
    - ./mvnw $MAVEN_CLI_OPTS -DskipTests package
  artifacts:
    expire_in: 1 week
    paths:
      - target/quarkus-app/**
      - target/*-runner.jar
  rules:
    - if: $CI_COMMIT_BRANCH

compose_build:
  stage: docker
  tags: 
    - kubernetes
  image: docker:26
  services:
    - name: docker:26-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    COMPOSE_FILE: docker-compose.yml
  script:
    - docker compose version
    - docker compose build --no-cache
  needs: ["package"]
  rules:
    - if: $CI_COMMIT_BRANCH

compose_up:
  stage: deploy
  tags: kubernetes
  image: docker:26
  services:
    - name: docker:26-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    COMPOSE_FILE: docker-compose.yml
  script:
    - docker compose up -d
    - docker compose ps
  needs: ["compose_build"]
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  allow_failure: false

integration-tests:
  stage: test
  tags: kubernetes
  image: maven:3.9-eclipse-temurin-21
  services:
    - name: postgres:16-alpine
      alias: pg
  variables:
    POSTGRES_DB: service_article
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    # Adapter l'URL JDBC pour pointer sur le service Postgres lanc√© par GitLab
    QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://pg:5432/service_article
    QUARKUS_DATASOURCE_USERNAME: postgres
    QUARKUS_DATASOURCE_PASSWORD: postgres
    MAVEN_CLI_OPTS: "-B -Dmaven.repo.local=.m2/repository"
  cache:
    key: "m2-${CI_PROJECT_ID}-${CI_COMMIT_REF_SLUG}"
    paths:
      - .m2/repository
    policy: pull-push
  script:
    - ./mvnw $MAVEN_CLI_OPTS -DskipTests=true -DskipITs=false verify
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - target/failsafe-reports/**
  needs: ["verify"]
  rules:
    - if: $CI_COMMIT_BRANCH
