stages:
  - test
  - build
  - docker
  - deploy

# Variables globales
variables:
  MAVEN_CLI_OPTS: "-B -Dmaven.repo.local=.m2/repository"
  DOCKER_BUILDKIT: "1"

default:
  image: maven:3.9-eclipse-temurin-21
  tags: 
    - kubernetes
  cache:
    key: "m2-${CI_PROJECT_ID}-${CI_COMMIT_REF_SLUG}"
    paths:
      - .m2/repository
    policy: pull-push

verify:
  stage: test
  script:
    - chmod +x ./mvnw
    - ./mvnw $MAVEN_CLI_OPTS -DskipTests=false -DskipITs=true verify
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - target/surefire-reports/**
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

integration-tests:
  stage: test
  services:
    - name: postgres:16-alpine
      alias: pg
  variables:
    POSTGRES_DB: service_article
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://pg:5432/service_article
    QUARKUS_DATASOURCE_USERNAME: postgres
    QUARKUS_DATASOURCE_PASSWORD: postgres
  script:
    - chmod +x ./mvnw
    - ./mvnw $MAVEN_CLI_OPTS -DskipTests=true -DskipITs=false verify
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - target/failsafe-reports/**
  rules:
    - if: $CI_COMMIT_BRANCH

package:
  stage: build
  needs: ["verify"]
  script:
    - chmod +x ./mvnw
    - ./mvnw $MAVEN_CLI_OPTS -DskipTests package
  artifacts:
    expire_in: 1 week
    paths:
      - target/quarkus-app/**
      - target/*-runner.jar
  rules:
    - if: $CI_COMMIT_BRANCH

build_image:
  stage: docker
  image: docker:26
  services:
    - name: docker:26-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
  script:
    - docker build -t ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA} .
    - docker build -t ${CI_REGISTRY_IMAGE}:latest .
  needs: ["package"]
  rules:
    - if: $CI_COMMIT_BRANCH

# Déploiement en production
deploy:production:
  stage: deploy
  image:
    name: bitnami/kubectl:latest
    entrypoint: ['']
  tags:
    - kubernetes
  needs:
    - job: build_image
      artifacts: false
  script:
    - echo "Configuration Kubernetes"
    - kubectl version --client
    - kubectl config current-context
    - echo "Creating namespace..."
    - kubectl create namespace production --dry-run=client -o yaml | kubectl apply -f -
    - echo "Creating Docker Registry Secret..."
    - >
      kubectl create secret docker-registry gitlab-registry
      --docker-server=$CI_REGISTRY
      --docker-username=$CI_REGISTRY_USER
      --docker-password=$CI_REGISTRY_PASSWORD
      --namespace=production
      --dry-run=client -o yaml | kubectl apply -f -
    - echo "Creating Database Secrets..."
    - >
      kubectl create secret generic article-service-secrets
      --from-literal=db.username="$QUARKUS_DATASOURCE_USERNAME"
      --from-literal=db.password="$QUARKUS_DATASOURCE_PASSWORD"
      --namespace=production
      --dry-run=client -o yaml | kubectl apply -f -
    - echo "Creating ConfigMap..."
    - >
      kubectl create configmap article-service-config
      --from-literal=datasource.jdbc.url="$QUARKUS_DATASOURCE_JDBC_URL"
      --namespace=production
      --dry-run=client -o yaml | kubectl apply -f -
    - echo "Deploying article-service..."
    - kubectl apply -f k8s/service.yaml -n production
    - kubectl apply -f k8s/ingress.yaml -n production
    - kubectl apply -f k8s/deployment.yaml -n production
    - echo "Updating image..."
    - DEPLOY_TAG=${CI_COMMIT_SHORT_SHA}
    - FULL_IMAGE="$CI_REGISTRY_IMAGE:$DEPLOY_TAG"
    - >
      kubectl set image deployment/article-service
      article-service=$FULL_IMAGE
      -n production --record
    - echo "Deployment completed"
    - kubectl rollout status deployment/article-service -n production --timeout=5m
  environment:
    name: production
    url: https://satisfactorysquad.freeboxos.fr/article-service
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  allow_failure: false

# Déploiement pour les branches de test
deploy:branch:
  stage: deploy
  image:
    name: bitnami/kubectl:latest
    entrypoint: ['']
  tags:
    - kubernetes
  needs:
    - job: build_image
      artifacts: false
  script:
    - echo "Configuration Kubernetes"
    - kubectl version --client
    - kubectl config current-context
    - echo "Creating namespace..."
    - kubectl create namespace $CI_COMMIT_REF_SLUG --dry-run=client -o yaml | kubectl apply -f -
    - echo "Creating Docker Registry Secret..."
    - >
      kubectl create secret docker-registry gitlab-registry
      --docker-server=$CI_REGISTRY
      --docker-username=$CI_REGISTRY_USER
      --docker-password=$CI_REGISTRY_PASSWORD
      --namespace=$CI_COMMIT_REF_SLUG
      --dry-run=client -o yaml | kubectl apply -f -
    - echo "Creating Database Secrets..."
    - >
      kubectl create secret generic article-service-secrets
      --from-literal=db.username="$QUARKUS_DATASOURCE_USERNAME"
      --from-literal=db.password="$QUARKUS_DATASOURCE_PASSWORD"
      --namespace=$CI_COMMIT_REF_SLUG
      --dry-run=client -o yaml | kubectl apply -f -
    - echo "Creating ConfigMap..."
    - >
      kubectl create configmap article-service-config
      --from-literal=datasource.jdbc.url="$QUARKUS_DATASOURCE_JDBC_URL"
      --namespace=$CI_COMMIT_REF_SLUG
      --dry-run=client -o yaml | kubectl apply -f -
    - echo "Deploying article-service..."
    - kubectl apply -f k8s/service.yaml -n $CI_COMMIT_REF_SLUG
    - kubectl apply -f k8s/ingress.yaml -n $CI_COMMIT_REF_SLUG
    - kubectl apply -f k8s/deployment.yaml -n $CI_COMMIT_REF_SLUG
    - echo "Updating image..."
    - DEPLOY_TAG=${CI_COMMIT_SHORT_SHA}
    - FULL_IMAGE="$CI_REGISTRY_IMAGE:$DEPLOY_TAG"
    - >
      kubectl set image deployment/article-service
      article-service=$FULL_IMAGE
      -n $CI_COMMIT_REF_SLUG --record
    - echo "Deployment completed"
    - kubectl rollout status deployment/article-service -n $CI_COMMIT_REF_SLUG --timeout=5m
  environment:
    name: $CI_COMMIT_REF_SLUG
    url: https://satisfactorysquad.freeboxos.fr/$CI_COMMIT_REF_SLUG/article-service
  rules:
    - if: $CI_COMMIT_BRANCH != "main"
  allow_failure: false

